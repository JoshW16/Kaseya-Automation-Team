<?xml version="1.0" encoding="utf-8"?>
<ScExport xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://www.kaseya.com/vsa/2008/12/Scripting">
  <Procedure name="Mitigate MS Exchange CVE-2022-41040 Vulnerability" treePres="3" id="1842787597" folderId="292207468157737" treeFullPath="myProcedures - vlad">
    <Body description="">
      <Statement description="The procedure mitigates the CVE-2022-41040 MS Exchange vulnerability according to Microsoft recommendation (https://msrc-blog.microsoft.com/2022/09/29/customer-guidance-for-reported-zero-day-vulnerabilities-in-microsoft-exchange-server/)&#xD;&#xA;Run the procedure on MS Exchange servers&#xD;&#xA;Version: 0.1&#xD;&#xA;Author: Proserv Team - VS" name="Execute Shell Command - Get Results to Variable" continueOnFail="false">
        <Parameter xsi:type="StringParameter" name="Parameter1" value="powershell -ExecutionPolicy Bypass -Command &quot;if ( $null -eq $( try { Add-PSSnapin Microsoft.Exchange.Management.PowerShell.SnapIn -ErrorAction Stop -PassThru } catch {$null} ) ) {Write-Output 'NoExchange'}&quot;" />
        <Parameter xsi:type="StringParameter" name="Parameter2" value="True" />
        <Parameter xsi:type="StringParameter" name="Parameter3" value="System" />
      </Statement>
      <If description="">
        <Condition name="CheckVariable">
          <Parameter xsi:type="StringParameter" name="VariableName" value="#global:cmdresults#" />
          <Parameter xsi:type="EnumParameter" name="Condition" value="Contains" />
          <Parameter xsi:type="StringParameter" name="Value" value="NoExchange" />
        </Condition>
        <Then>
          <Statement name="WriteScriptLogEntry" continueOnFail="false">
            <Parameter xsi:type="StringParameter" name="Comment" value="No Exchange Management Shell detected. Execute the procedure on an Exchange Server" />
          </Statement>
        </Then>
        <Else>
          <Statement name="Execute Shell Command - Get Results to Variable" continueOnFail="false">
            <Parameter xsi:type="StringParameter" name="Parameter1" value="powershell -ExecutionPolicy Bypass -Command &quot;$Site = 'iis:\sites\Default Web Site'; $F = &quot;&quot;&quot;system.webServer/rewrite/rules/rule[@name='CVE-2022-41040-Block$_']&quot;&quot;&quot;; Clear-WebConfiguration -PSPath $Site -Filter $F; Add-WebConfigurationProperty -PSPath $Site -Filter 'system.webServer/rewrite/rules' -Name '.' -Value @{name='CVE-2022-41040-Block' + $_ ;patternSyntax='Regular Expressions';stopProcessing='False'}; Set-WebConfigurationProperty -PSPath $Site -Filter &quot;&quot;&quot;$F/match&quot;&quot;&quot; -Name 'url' -Value '.*'; Set-WebConfigurationProperty -PSPath $Site -Filter $F -Name 'conditions' -Value (@{'input'=&quot;&quot;&quot;{REQUEST_URI}&quot;&quot;&quot;;pattern='.*autodiscover\.json.*\@.*Powershell.*';ignoreCase='true';negate='false'}); Set-WebConfigurationProperty -PSPath $Site -Filter $F -Name &quot;&quot;&quot;action&quot;&quot;&quot; -Value (@{type='CustomResponse';statusCode=403;statusReason='Forbidden: Access is denied.';statusDescription='You do not have permission to view this directory or page using the credentials that you supplied.'})&quot;" />
            <Parameter xsi:type="StringParameter" name="Parameter2" value="True" />
            <Parameter xsi:type="StringParameter" name="Parameter3" value="System" />
          </Statement>
        </Else>
      </If>
    </Body>
  </Procedure>
</ScExport>