<#
    Detects if Malwarebytes installed on the Windows computer. Uninstalls it if already installed.
#>

#Create VSA X Event Source if it doesn't exist
if ( -not [System.Diagnostics.EventLog]::SourceExists("VSA X")) {
    [System.Diagnostics.EventLog]::CreateEventSource("VSA X", "Application")
}

#region function Get-FileFromURI
function Get-FileFromURI {
    [OutputType([bool])]
    param (
        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]
        [string] $DownloadUrl,

        [parameter(Mandatory = $true)]
        [ValidateNotNullOrEmpty()]
        [string] $SaveTo
    )
    [bool] $Result = $false

    $ResponseCode = try {
        (Invoke-WebRequest -Uri $DownloadUrl -OutFile $SaveTo -UseBasicParsing -TimeoutSec 600 -PassThru -ErrorAction Stop).StatusCode
    } catch {
        $_.Exception.Response.StatusCode.value__
    }

    if (200 -eq $ResponseCode) {
        if (Test-Path -Path $SaveTo ) {
            Unblock-File -Path $SaveTo
            $Result = $true
        } else {
            [System.Diagnostics.EventLog]::WriteEntry("VSA X", "Unable to find downloaded file at <$SaveTo>", "Error", 400)
        }
    } else {
        [System.Diagnostics.EventLog]::WriteEntry("VSA X", "Unable to download from <$DownloadUrl> to <$SaveTo>. Response: [$ResponseCode]", "Error", 400)
    }
    return $Result
}
#endregion function Get-FileFromURI

#check if Malwarebytes already installed
[int] $DetectApp = (Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*' | Where-Object {$_.Publisher -match 'Malwarebytes'} | Measure-Object).Count

if (0 -lt $DetectApp) {
    #Download & execute uninstaller
    [string]$UninstallerUrl = "https://downloads.malwarebytes.com/file/mbstcmd"
    $UninstallerPath = "$env:TEMP\mbstcmd.exe"
    [bool] $IsUninstallerObtained = Get-FileFromURI -DownloadUrl $UninstallerUrl -SaveTo $UninstallerPath
    if ( $IsUninstallerObtained ) {
        #Uninstall
        Start-Process -FilePath $UninstallerPath -ArgumentList '/y /cleanup /noreboot /nopr' -Wait
        #Check if uninstallation was successful
        $DetectApp = (Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*' | Where-Object {$_.Publisher -match 'Malwarebytes'} | Measure-Object).Count
        if (0 -lt $DetectApp) {
            [System.Diagnostics.EventLog]::WriteEntry("VSA X", "Malwarebytes uninstallation was not successful", "Error", 400)            
        } else {
            [System.Diagnostics.EventLog]::WriteEntry("VSA X", "Malwarebytes was removed", "Information", 200)
        }
        #Cleanup
        Get-ChildItem -Path $env:TEMP | Where-Object { $_.Name -like "mbstcmd.exe"} | Remove-Item -Force -Confirm:$false 
    }
}